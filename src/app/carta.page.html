<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>
      <ion-icon
        name="restaurant"
        slot="start"
        style="margin-right: 8px"
        aria-hidden="true"
      ></ion-icon>
      {{textos.carta || 'Carta'}}
    </ion-title>
    <ion-buttons slot="end">
      <div id="google_translate_element"></div>
      <select
        [(ngModel)]="idioma"
        (change)="setIdioma(idioma)"
        style="min-width: 120px; margin-left: 1em"
      >
        <option *ngFor="let lang of idiomas" [value]="lang.code">
          {{lang.label}}
        </option>
      </select>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-grid>
    <ion-row>
      <ion-col size="12" class="ion-text-center">
        <h2 *ngIf="mesa">{{textos.mesa || 'Mesa'}} {{ mesa }}</h2>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col size="12" class="ion-text-center" style="margin-bottom: 1em">
        <ion-button
          *ngFor="let cat of categorias"
          (click)="seleccionarCategoria(cat.nombre)"
          fill="clear"
          [strong]="categoriaSeleccionada === cat.nombre"
          [color]="categoriaSeleccionada === cat.nombre ? 'primary' : 'medium'"
          [ngClass]="{'categoria-activa': categoriaSeleccionada === cat.nombre}"
          style="border-radius: 0; margin: 0 0.5em; font-weight: bold"
        >
          {{cat.nombreTrad || cat.nombre}}
        </ion-button>
      </ion-col>
    </ion-row>
    <ion-row *ngIf="categoriaSeleccionada">
      <ion-col size="12">
        <h3>
          <ion-icon name="albums" aria-hidden="true"></ion-icon>
          {{categoriaSeleccionada}}
        </h3>
        <ion-list>
          <ng-container
            *ngFor="let prod of getProductosPorCategoriaSeleccionada()"
          >
            <ion-item>
              <ion-label>
                <h4>
                  {{ prod.nombreTrad || prod.nombre }}
                  <span
                    style="
                      color: var(--ion-color-success);
                      font-weight: bold;
                      margin-left: 10px;
                    "
                  >
                    {{ prod.precio | currency:'EUR':'symbol':'1.2-2' }}
                  </span>
                </h4>
                <p *ngIf="prod.descripcion">
                  {{prod.descripcionTrad || prod.descripcion}}
                </p>
                <p *ngIf="prod.alergenos">
                  <strong>{{textos.alergenos || 'Alergenos'}}:</strong>
                  {{prod.alergenosTrad || prod.alergenos}}
                </p>
                <div *ngIf="prod.opciones && prod.opciones.length">
                  <strong>{{textos.opciones || 'Opciones'}}:</strong>
                  <ion-segment
                    [ngModel]="getOpcionSeleccionada(prod)"
                    (ngModelChange)="onSeleccionOpcion(prod, $event)"
                  >
                    <ion-segment-button
                      *ngFor="let op of prod.opciones; let i = index"
                      [value]="op"
                    >
                      {{prod.opcionesTrad && prod.opcionesTrad[i] ?
                      prod.opcionesTrad[i] : op}}
                    </ion-segment-button>
                  </ion-segment>
                </div>
              </ion-label>
              <ion-button
                fill="solid"
                color="success"
                (click)="agregarProducto(prod)"
                [disabled]="!puedeAgregarProducto(prod)"
              >
                <ion-icon name="add-circle" slot="start"></ion-icon>
                {{textos.anadir || 'Añadir'}}
              </ion-button>
              <ion-button
                fill="solid"
                color="danger"
                (click)="quitarProducto(prod)"
                *ngIf="seleccionados[prod.id] && seleccionados[prod.id].cantidad"
              >
                <ion-icon name="remove-circle" slot="start"></ion-icon>
                {{textos.quitar || 'Quitar'}}
              </ion-button>
              <span
                *ngIf="seleccionados[prod.id] && seleccionados[prod.id].cantidad"
                style="
                  margin-left: 8px;
                  font-weight: bold;
                  color: var(--ion-color-primary);
                "
                >x{{seleccionados[prod.id].cantidad}}</span
              >
            </ion-item>
          </ng-container>
        </ion-list>
      </ion-col>
    </ion-row>
    <ion-row *ngIf="pagoSolicitado">
      <ion-col size="12">
        <ion-card color="warning">
          <ion-card-header>
            <ion-card-title
              >{{textos.pagoSolicitado || 'Pago solicitado'}}</ion-card-title
            >
          </ion-card-header>
          <ion-card-content>
            {{textos.pagoSolicitadoMsg || 'El pago de esta mesa ha sido
            solicitado. No se pueden añadir más productos hasta que el
            administrador confirme el pago.'}}
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
    <ion-row *ngIf="!pagoSolicitado && mesa && seleccionadosKeys().length">
      <ion-col size="12">
        <ion-card>
          <ion-card-header>
            <ion-card-title
              >{{textos.resumen || 'Resumen del pedido'}}</ion-card-title
            >
          </ion-card-header>
          <ion-card-content>
            <ul>
              <li *ngFor="let id of seleccionadosKeys()">
                {{getNombreProducto(id)}} x{{seleccionados[id].cantidad}}
                <span *ngIf="seleccionados[id].opciones.length"
                  >- {{textos.opciones || 'Opciones'}}:
                  {{seleccionados[id].opciones.join(', ')}}</span
                >
                <span
                  style="
                    margin-left: 10px;
                    color: var(--ion-color-success);
                    font-weight: bold;
                  "
                >
                  {{getPrecioProducto(id) * seleccionados[id].cantidad |
                  currency:'EUR':'symbol':'1.2-2'}}
                </span>
              </li>
            </ul>
            <div
              style="
                text-align: right;
                margin-top: 1em;
                font-size: 1.2em;
                font-weight: bold;
              "
            >
              {{textos.total || 'Total'}}: {{getTotalPedido() |
              currency:'EUR':'symbol':'1.2-2'}}
            </div>
            <ion-button expand="block" color="primary" (click)="enviarPedido()">
              <ion-icon name="send" slot="start"></ion-icon>
              {{textos.enviarPedido || 'Enviar pedido'}}
            </ion-button>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
    <ion-row
      *ngIf="!pagoSolicitado && mesa && !seleccionadosKeys().length && (!comandaMesa || !comandaMesa.items || !comandaMesa.items.length)"
    >
      <ion-col size="12">
        <ion-card>
          <ion-card-header>
            <ion-card-title
              >{{textos.sinPedido || 'Sin pedido'}}</ion-card-title
            >
          </ion-card-header>
          <ion-card-content>
            {{textos.noProductos || 'No hay productos en el pedido de esta
            mesa.'}}
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
    <ion-row
      *ngIf="mesa && comandaMesa && comandaMesa.items && comandaMesa.items.length"
    >
      <ion-col size="12">
        <ion-card>
          <ion-card-header>
            <ion-card-title>Estado de tu pedido</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div>
              <strong>Estado:</strong>
              <span [ngSwitch]="comandaMesa.estado">
                <span
                  *ngSwitchCase="'preparando'"
                  style="color: orange; font-weight: bold"
                  >En preparación</span
                >
                <span
                  *ngSwitchCase="'preparado'"
                  style="color: green; font-weight: bold"
                  >Preparado</span
                >
                <span
                  *ngSwitchCase="'pago_pendiente'"
                  style="color: #c77d00; font-weight: bold"
                  >Pago pendiente</span
                >
                <span *ngSwitchDefault style="color: gray; font-weight: bold"
                  >Recibido</span
                >
              </span>
            </div>
            <div style="margin-top: 0.5em">
              <strong>Pedido:</strong>
              <ul>
                <li *ngFor="let item of comandaMesa.items">
                  {{item.nombre}} x{{item.cantidad}}
                  <span *ngIf="item.opciones.length"
                    >- Opciones: {{item.opciones.join(', ')}}</span
                  >
                </li>
              </ul>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
    <ion-row *ngIf="mesa && historialComandasMesa.length">
      <ion-col size="12">
        <ion-card>
          <ion-card-header>
            <ion-card-title>Historial de pedidos de esta mesa</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <ion-item *ngFor="let comanda of historialComandasMesa">
                <ion-label>
                  <strong>Fecha:</strong> {{comanda.fecha | date:'short'}}<br />
                  <strong>Estado:</strong>
                  <span [ngSwitch]="comanda.estado">
                    <span
                      *ngSwitchCase="'preparando'"
                      style="color: orange; font-weight: bold"
                      >En preparación</span
                    >
                    <span
                      *ngSwitchCase="'preparado'"
                      style="color: green; font-weight: bold"
                      >Preparado</span
                    >
                    <span
                      *ngSwitchDefault
                      style="color: gray; font-weight: bold"
                      >Recibido</span
                    >
                  </span>
                  <div style="margin-top: 0.5em">
                    <strong>Pedido:</strong>
                    <ul>
                      <li *ngFor="let item of comanda.items">
                        {{item.nombre}} x{{item.cantidad}}
                        <span *ngIf="item.opciones.length"
                          >- Opciones: {{item.opciones.join(', ')}}</span
                        >
                      </li>
                    </ul>
                  </div>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
    <ion-row *ngIf="mesa && historialComandasMesa.length">
      <ion-col size="12">
        <ion-card>
          <ion-card-header>
            <ion-card-title>Total y pago</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div
              style="font-size: 1.2em; font-weight: bold; margin-bottom: 1em"
            >
              Total a pagar: {{getTotalHistorialMesa() |
              currency:'EUR':'symbol':'1.2-2'}}
            </div>
            <ion-button expand="block" color="success" (click)="solicitarPago()"
              >Pagar</ion-button
            >
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
    <ion-modal *ngIf="mostrarResumenPago">
      <ng-template>
        <ion-header>
          <ion-toolbar color="primary">
            <ion-title>Resumen de pago</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="cerrarResumenPago()">
                <ion-icon name="close"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <ion-card>
            <ion-card-header>
              <ion-card-title>Resumen de la mesa {{mesa}}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-list>
                <ion-item *ngFor="let comanda of historialComandasMesa">
                  <ion-label>
                    <strong>Fecha:</strong> {{comanda.fecha | date:'short'}}<br />
                    <ul>
                      <li *ngFor="let item of comanda.items">
                        {{item.nombre}} x{{item.cantidad}}
                        <span *ngIf="item.opciones.length"
                          >- Opciones: {{item.opciones.join(', ')}}</span
                        >
                      </li>
                    </ul>
                  </ion-label>
                </ion-item>
              </ion-list>
              <div style="font-size: 1.2em; font-weight: bold; margin-top: 1em">
                Total: {{getTotalHistorialMesa() |
                currency:'EUR':'symbol':'1.2-2'}}
              </div>
            </ion-card-content>
          </ion-card>
        </ion-content>
      </ng-template>
    </ion-modal>
  </ion-grid>
</ion-content>
