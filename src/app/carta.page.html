<ion-header [translucent]="true" class="ion-no-border">
  <ion-toolbar color="light">
    <ion-title>
      <div style="display: flex; align-items: center; gap: 8px">
        <ion-icon name="restaurant" color="primary"></ion-icon>
        <span style="font-weight: 800; letter-spacing: -0.5px">
          {{ restauranteNombre || ('MENU.TITLE' | translate) }}
        </span>
      </div>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button
        *ngIf="showLanguageSelector"
        (click)="presentLanguagePopover($event)"
        fill="clear"
      >
        <span class="language-flag">{{ getCurrentLanguageFlag() }}</span>
        <ion-icon name="chevron-down" size="small"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="carta-content">
  <!-- Hero Section -->
  <div class="menu-hero" *ngIf="cabeceraImagen">
    <img [src]="cabeceraImagen" class="menu-hero-img" alt="Restaurant Header" />
    <div class="menu-hero-overlay">
      <h1 class="menu-hero-title">{{ restauranteNombre }}</h1>
    </div>
  </div>

  <!-- Categories Sticky Selection -->
  <div class="categorias-wrapper">
    <div class="categorias-scroll">
      <button
        *ngFor="let cat of categorias"
        (click)="seleccionarCategoria(cat.id)"
        [class.selected]="categoriaSeleccionada === cat.id"
        class="categoria-btn"
      >
        {{ getNombreCategoria(cat) }}
      </button>
    </div>
  </div>

  <div class="main-container" style="padding-bottom: 40px">
    <!-- Historial de pedidos -->
    <div *ngIf="mesa && historialComandasMesa.length" class="historial-bar">
      <ion-item
        button
        detail="false"
        lines="none"
        (click)="mostrarHistorial = !mostrarHistorial"
        style="--padding-start: 1rem"
      >
        <ion-icon
          [name]="mostrarHistorial ? 'chevron-up' : 'chevron-down'"
          slot="start"
          color="primary"
        ></ion-icon>
        <ion-label>
          <h2 style="font-weight: 700; margin: 0">
            {{ 'MENU.ORDER_HISTORY' | translate }}
          </h2>
        </ion-label>
        <ion-badge
          slot="end"
          color="primary"
          *ngIf="!mostrarHistorial"
          style="padding: 6px 10px; border-radius: 8px"
        >
          {{getTotalHistorialMesa() | currency:'EUR':'symbol':'1.2-2'}}
        </ion-badge>
      </ion-item>

      <div *ngIf="mostrarHistorial" style="padding: 0 1rem 1rem">
        <div class="historial-lista">
          <div
            *ngFor="let comanda of historialComandasMesa"
            class="historial-item"
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
              "
            >
              <span class="historial-fecha">{{comanda.fecha | date:'shortTime'}}</span>
              <div class="historial-estado">
                <ion-badge [color]="comanda.estado === 'preparado' ? 'success' : (comanda.estado === 'preparando' ? 'warning' : 'medium')">
                  {{ comanda.estado === 'preparado' ? ('MENU.STATUS_PREPARED' | translate) : (comanda.estado === 'preparando' ? ('MENU.STATUS_PREPARING' | translate) : ('MENU.STATUS_RECEIVED' | translate)) }}
                </ion-badge>
                <ion-button
                  fill="clear"
                  size="small"
                  *ngIf="comanda.estado === 'pendiente' || comanda.estado === 'STATUS_RECEIVED'"
                  (click)="editarComanda(comanda); $event.stopPropagation()"
                >
                  <ion-icon name="pencil" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
            </div>
            <ul class="historial-pedido" style="list-style: none; padding-left: 0; margin: 0">
              <li *ngFor="let item of comanda.items" style="font-size: 0.9em; margin-bottom: 4px; color: var(--text-main)">
                <span style="font-weight: 600">x{{ item.cantidad }}</span> {{ getNombreItemParaMostrar(item) }}
                <div *ngIf="getOpcionesItemParaMostrar(item).length" style="font-size: 0.85em; color: var(--text-muted); margin-left: 1.5em">
                  {{ getOpcionesItemParaMostrar(item).join(', ') }}
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div
          style="
            text-align: right;
            border-top: 1px solid #f1f5f9;
            margin-top: 1rem;
            padding-top: 0.75rem;
          "
        >
          <span style="font-weight: 800; font-size: 1.1em">
            {{ 'MENU.TOTAL_PAID' | translate }}: {{getTotalHistorialMesa() | currency:'EUR':'symbol':'1.2-2'}}
          </span>
        </div>
      </div>

      <!-- Botón Solicitar Pago -->
      <div
        *ngIf="mesa && historialComandasMesa.length && !pagoSolicitado"
        style="padding: 0 1rem 1rem; display: flex; gap: 10px;"
      >
        <ion-button
          expand="block"
          color="warning"
          (click)="solicitarPago()"
          style="--border-radius: 12px; font-weight: 700; height: 48px; flex: 1;"
        >
          <ion-icon name="cash-outline"></ion-icon>
          {{ 'MENU.REQUEST_PAYMENT' | translate }}
        </ion-button>
        
        <ion-button
          expand="block"
          fill="outline"
          color="medium"
          (click)="abrirCalculadoraSeparada()"
          style="--border-radius: 12px; font-weight: 700; height: 48px; flex: 1;"
        >
          <ion-icon name="calculator-outline"></ion-icon>
          {{ 'COMMON.CALCULATE_SEPARATELY' | translate }}
        </ion-button>
      </div>
    </div>

    <!-- Lista de Productos -->
    <div class="productos-lista">
      <ng-container
        *ngIf="getProductosPorCategoriaSeleccionada().length; else sinProductos"
      >
        <div
          *ngFor="let prod of getProductosPorCategoriaSeleccionada()"
          class="producto-card"
          [class.agotado]="prod.agotado"
        >
          <div class="producto-flex-row">
            <!-- Imagen con aspecto 16:9 o similar -->
            <div class="producto-img-container">
              <img 
                *ngIf="prod.imagen" 
                [src]="prod.imagen" 
                [alt]="prod.nombre" 
                loading="lazy" 
                (click)="abrirImagenAmpliada(prod.imagen)"
              />
              <div *ngIf="!prod.imagen" class="no-img-placeholder">
                <ion-icon name="restaurant-outline"></ion-icon>
              </div>
              <div *ngIf="prod.agotado" class="badge-agotado">
                {{ 'MENU.OUT_OF_STOCK' | translate | uppercase }}
              </div>
            </div>

            <div class="producto-info">
              <div class="producto-header">
                <span class="producto-nombre">{{ getNombre(prod) }}</span>
                 <!-- Promotion Badge -->
                 <div *ngIf="getBestPromotion(prod.id) as promo" style="margin-left: 8px; display: inline-flex;">
                    <ion-badge color="danger" *ngIf="isPromotionActive(promo)">
                        {{ promo.type === '2x1' ? '2x1' : (promo.type === 'discount_percent' ? '-' + promo.value + '%' : 'OFERTA') }}
                    </ion-badge>
                 </div>
              </div>
              
              <div class="producto-price-container" style="display: flex; align-items: center; gap: 8px;">
                 <!-- Original Price (Strikethrough if active promo) -->
                 <span [style.text-decoration]="isPromotionActive(getBestPromotion(prod.id)!) && getBestPromotion(prod.id)!.type === 'discount_percent' ? 'line-through' : 'none'"
                       [style.color]="isPromotionActive(getBestPromotion(prod.id)!) && getBestPromotion(prod.id)!.type === 'discount_percent' ? 'var(--text-muted)' : 'var(--text-main)'"
                       [style.font-size]="isPromotionActive(getBestPromotion(prod.id)!) && getBestPromotion(prod.id)!.type === 'discount_percent' ? '0.9em' : '1.1em'"
                       class="producto-precio">
                   {{ prod.precio | currency:'EUR':'symbol':'1.2-2' }}
                 </span>
                 
                 <!-- Discounted Price -->
                 <span *ngIf="isPromotionActive(getBestPromotion(prod.id)!) && getBestPromotion(prod.id)!.type === 'discount_percent'"
                       class="producto-precio" style="color: var(--ion-color-danger); font-weight: 800;">
                    {{ getEffectiveItemPriceForOrder(prod, 1) | currency:'EUR':'symbol':'1.2-2' }}
                 </span>
              </div>
              
              <p class="producto-desc">{{ getDescripcion(prod) }}</p>

              <div *ngIf="getAlergenos(prod)" class="producto-alergenos">
                <ion-icon name="warning-outline" color="warning"></ion-icon>
                <span>{{ 'MENU.ALLERGENS' | translate }}: {{getAlergenos(prod)}}</span>
              </div>

              <!-- Opciones del producto -->
              <div
                *ngIf="getOpciones(prod) && getOpciones(prod).length"
                style="margin-top: 0.5rem"
              >
                <ion-segment
                  mode="md"
                  [ngModel]="getOpcionSeleccionada(prod)"
                  (ngModelChange)="onSeleccionOpcion(prod, $event)"
                  style="--background: #f1f5f9; border-radius: 10px; padding: 2px"
                >
                  <ion-segment-button
                    *ngFor="let op of getOpciones(prod); let i = index"
                    [value]="op"
                    style="--border-radius: 8px; font-size: 0.8em; min-height: 32px"
                  >
                    <ion-label>{{op}}</ion-label>
                  </ion-segment-button>
                </ion-segment>
              </div>

              <!-- Acciones de cantidad -->
              <div class="producto-acciones">
                <ion-button
                  fill="clear"
                  color="danger"
                  (click)="quitarProducto(prod)"
                  *ngIf="productoTieneSeleccion(prod)"
                  class="btn-circle"
                >
                  <ion-icon name="remove-circle" style="font-size: 32px"></ion-icon>
                </ion-button>

                <span
                  *ngIf="productoTieneSeleccion(prod)"
                  class="producto-cantidad"
                >
                  {{ cantidadSeleccionadaProducto(prod) }}
                </span>

                <ion-button
                  fill="clear"
                  color="success"
                  (click)="agregarProducto(prod)"
                  *ngIf="showAddProduct && !prod.agotado"
                  [disabled]="!puedeAgregarProducto(prod)"
                  class="btn-circle"
                >
                  <ion-icon name="add-circle" style="font-size: 32px"></ion-icon>
                </ion-button>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
      <ng-template #sinProductos>
        <div style="text-align: center; padding: 3rem 1rem; color: var(--text-muted)">
          <ion-icon name="restaurant-outline" style="font-size: 48px; opacity: 0.2"></ion-icon>
          <p style="margin-top: 1rem">{{ 'MENU.NO_ITEMS' | translate }}</p>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Barra flotante de resumen -->
  <div
    class="pedido-bar"
    *ngIf="!pagoSolicitado && mesa && seleccionadosKeys().length"
  >
    <div class="pedido-bar-info" (click)="abrirResumenPedido()">
      <span class="pedido-bar-cantidad">
        {{ seleccionadosKeys().length }} {{ (seleccionadosKeys().length === 1 ? 'MENU.PRODUCT' : 'MENU.PRODUCT_PLURAL') | translate }}
      </span>
      <span class="pedido-bar-total">
        {{ getTotalPedido() | currency:'EUR':'symbol':'1.2-2' }}
      </span>
    </div>
    <ion-button
      class="pedido-bar-btn"
      (click)="enviarPedido()"
      mode="ios"
    >
      <ion-icon name="send" slot="start"></ion-icon>
      {{ 'MENU.SEND_ORDER' | translate }}
    </ion-button>
  </div>

  <!-- Modales (Resumen, Edición, Imagen) - Manteniendo funcionalidad original -->
  <!-- Resumen Pedido -->
  <ion-modal
    [isOpen]="modalResumenAbierto"
    (didDismiss)="modalResumenAbierto = false"
    [initialBreakpoint]="0.5"
    [breakpoints]="[0, 0.5, 0.9]"
  >
    <ng-template>
      <ion-header mode="md" class="ion-no-border">
        <ion-toolbar>
          <ion-title style="font-weight: 800">{{ 'MENU.ORDER_SUMMARY' | translate }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="modalResumenAbierto = false">
              <ion-icon name="close-circle" size="large" color="medium"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <div class="resumen-lista">
          <div *ngFor="let key of seleccionadosKeys()" class="resumen-item">
            <div style="display: flex; flex-direction: column; gap: 4px">
              <span style="font-weight: 700; color: var(--text-main)">{{getNombreProducto(key)}}</span>
              <div class="resumen-controls">
                <ion-button size="small" fill="clear" color="danger" (click)="disminuirCantidadKey(key)">
                  <ion-icon name="remove-circle-outline" size="small"></ion-icon>
                </ion-button>
                <span style="font-weight: 800; min-width: 25px; text-align: center">
                  {{seleccionados[key].cantidad}}
                </span>
                <ion-button size="small" fill="clear" color="success" (click)="aumentarCantidadKey(key)">
                  <ion-icon name="add-circle-outline" size="small"></ion-icon>
                </ion-button>
                <ion-button size="small" color="danger" fill="clear" (click)="eliminarItemResumen(key)">
                  <ion-icon name="trash-outline" size="small"></ion-icon>
                </ion-button>
              </div>
            </div>
            <span style="font-weight: 800; color: var(--text-main)">
              {{getPrecioProducto(key) * seleccionados[key].cantidad | currency:'EUR':'symbol':'1.2-2'}}
            </span>
          </div>
        </div>
        <div style="padding: 1.5rem; text-align: right; border-top: 1px solid #f1f5f9">
          <span style="font-size: 1.4em; font-weight: 900">
            TOTAL: {{ getTotalPedido() | currency:'EUR':'symbol':'1.2-2' }}
          </span>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Edición Comanda -->
  <ion-modal [isOpen]="editarModalAbierto" (didDismiss)="cancelarEdicion()">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>{{ 'MENU.EDIT_ORDER' | translate }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cancelarEdicion()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <div *ngIf="editingComanda" class="edit-comanda-lista" style="padding: 1rem">
          <div *ngFor="let item of editingComanda.items; let i = index" class="resumen-item" style="margin-bottom: 1rem">
            <div style="display: flex; flex-direction: column; gap: 4px">
              <span style="font-weight: 700">{{ getNombreItemParaMostrar(item) }}</span>
              <div class="resumen-controls">
                <ion-button size="small" fill="clear" (click)="disminuirCantidadItem(i)">
                  <ion-icon name="remove-circle-outline"></ion-icon>
                </ion-button>
                <span style="font-weight: 800">x{{ item.cantidad }}</span>
                <ion-button size="small" fill="clear" (click)="aumentarCantidadItem(i)">
                  <ion-icon name="add-circle-outline"></ion-icon>
                </ion-button>
                <ion-button size="small" color="danger" fill="clear" (click)="eliminarItemEditar(i)">
                  <ion-icon name="trash-outline"></ion-icon>
                </ion-button>
              </div>
            </div>
          </div>
          <ion-item lines="none" style="margin-top: 1rem; --background: #f8fafc; border-radius: 12px">
            <ion-label position="stacked" style="font-weight: 700">{{ 'MENU.OBSERVATIONS' | translate }}</ion-label>
            <ion-textarea [(ngModel)]="editingComanda.observaciones" rows="4"></ion-textarea>
          </ion-item>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem">
            <ion-button expand="block" color="medium" fill="soft" (click)="cancelarEdicion()" style="--border-radius: 12px">
              {{ 'MENU.CANCEL' | translate }}
            </ion-button>
            <ion-button expand="block" color="primary" (click)="enviarModificacionComanda()" style="--border-radius: 12px; font-weight: 700">
              {{ 'MENU.SEND_MODIFICATION' | translate }}
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Estado Pago -->
  <div *ngIf="pagoSolicitado" class="estado-pago-bar">
    <div style="display: flex; flex-direction: column; flex: 1">
      <div style="display: flex; align-items: center; gap: 8px; color: #92400e; font-weight: 800">
        <ion-icon name="alert-circle" size="large"></ion-icon>
        <span>{{ 'MENU.PAYMENT_REQUESTED' | translate }}</span>
      </div>
    </div>
    <div style="display: flex; gap: 8px;">
      <ion-button
        color="secondary"
        (click)="abrirCalculadoraSeparada()"
        style="--border-radius: 12px; font-weight: 700"
      >
        <ion-icon name="calculator-outline" slot="start"></ion-icon>
        Calcular
      </ion-button>
      
      <ion-button
        color="primary"
        (click)="descargarInformeMesa()"
        style="--border-radius: 12px; font-weight: 700"
      >
        <ion-icon name="download" slot="start"></ion-icon>
        PDF
      </ion-button>
    </div>
  </div>

  <!-- Imagen Ampliada -->
  <div
    *ngIf="imagenAmpliada"
    class="modal-imagen-ampliada"
    (click)="cerrarImagenAmpliada()"
    style="backdrop-filter: blur(10px)"
  >
    <div class="modal-imagen-contenido" (click)="$event.stopPropagation()" style="background: transparent; box-shadow: none">
      <button class="cerrar-modal" (click)="cerrarImagenAmpliada()" style="color: white; right: 0; top: -40px">
        <ion-icon name="close-circle" size="large"></ion-icon>
      </button>
      <img [src]="imagenAmpliada" [alt]="'MENU.IMAGE_EXPANDED' | translate" style="border-radius: 20px" />
    </div>
  </div>

  <!-- FAB Llamar Camarero -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" class="fab-llamar-camarero">
    <ion-fab-button class="fab-button-camarero" (click)="llamarCamarero()" style="--box-shadow: 0 4px 16px rgba(0,0,0,0.2)">
      <ion-icon name="hand-right" class="icon-camarero" style="font-size: 28px"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
