<ion-header class="ion-no-border">
  <ion-toolbar class="historial-header">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin" [attr.aria-label]="'HISTORY.BACK_TO_PANEL' | translate"></ion-back-button>
    </ion-buttons>
    <ion-title>
      <div style="display: flex; align-items: center">
        <ion-icon name="archive-outline" style="margin-right: 8px"></ion-icon>
        {{ 'HISTORY.TITLE' | translate }}
      </div>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="presentLanguagePopover($event)">
        <span style="font-size: 1.5rem">{{ getCurrentLanguageFlag() }}</span>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding-bottom">
  <!-- Filtros -->
  <ion-card class="filter-card">
    <ion-card-header>
      <ion-card-title>{{ 'HISTORY.VIEW_CONFIG' | translate }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item lines="none" class="ion-no-padding">
        <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
        <ion-datetime
          presentation="date"
          [value]="filtroFecha || ''"
          (ionChange)="setFecha($event)"
          display-format="YYYY-MM-DD"
          [attr.aria-label]="'HISTORY.SELECT_DATE_FILTER' | translate"
        ></ion-datetime>
      </ion-item>
      
      <ion-button
        expand="block"
        shape="round"
        class="ion-margin-top"
        (click)="aplicarFiltrosAsync()"
        [attr.aria-label]="'HISTORY.APPLY_DATE_FILTER' | translate"
      >
        <ion-icon name="filter-outline" slot="start"></ion-icon>
        {{ 'HISTORY.UPDATE_HISTORY' | translate }}
      </ion-button>

      <div *ngIf="mesas.length > 1" class="ion-margin-top">
        <ion-label color="medium" class="ion-margin-bottom" style="display: block;">
          <b>{{ 'HISTORY.FILTER_BY_TABLE' | translate }}:</b>
        </ion-label>
        <ion-segment
          [(ngModel)]="filtroMesa"
          (ionChange)="filtrarSoloVistaMesa()"
          scrollable
        >
          <ion-segment-button value="" [attr.aria-label]="'HISTORY.SHOW_ALL_TABLES' | translate">
            <ion-label>{{ 'COMMON.ALL' | translate }}</ion-label>
          </ion-segment-button>
          <ion-segment-button *ngFor="let mesa of mesas" [value]="mesa" [attr.aria-label]="'HISTORY.FILTER_TABLE' | translate:{mesa: mesa}">
            <ion-label>{{ mesa }}</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Resumen del día -->
  <ion-card class="summary-card" *ngIf="mesas.length > 0">
    <ion-card-content>
      <ion-grid class="ion-no-padding">
        <ion-row>
          <ion-col size="6" class="summary-item" style="border-right: 1px solid #eee;">
            <span class="summary-label">{{ 'HISTORY.TOTAL_INVOICED' | translate }}</span>
            <span class="summary-value" [attr.aria-label]="'HISTORY.TOTAL_INVOICED_TODAY' | translate">
              {{ resumenDia.total | currency:'EUR':'symbol':'1.2-2' }}
            </span>
          </ion-col>
          <ion-col size="6" class="summary-item">
            <span class="summary-label">{{ 'HISTORY.TABLES_SERVED' | translate }}</span>
            <span class="summary-value" [attr.aria-label]="'HISTORY.TABLES_SERVED_TODAY' | translate">
              {{ resumenDia.mesas }}
            </span>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Listado de registros -->
  <div *ngIf="mesas.length > 0">
    <ion-list-header>
      <ion-label>{{ 'HISTORY.CONSUMPTION_DETAIL' | translate }}</ion-label>
    </ion-list-header>

    <ion-accordion-group [multiple]="true">
      <ng-container *ngFor="let mesa of mesas">
        <ion-accordion 
          *ngIf="(!filtroMesa && mesas.length > 0) || filtroMesa === mesa" 
          [value]="mesa" 
          class="mesa-accordion"
        >
          <ion-item slot="header" lines="none">
            <div class="mesa-header-content">
              <div class="mesa-title">{{ 'HISTORY.TABLE' | translate }} {{ mesa }}</div>
              <ion-badge color="primary" class="total-badge">
                {{ getTotalMesa(mesa) | currency:'EUR':'symbol':'1.2-2' }}
              </ion-badge>
            </div>
          </ion-item>

          <div slot="content" class="ion-padding">
            <div *ngFor="let registro of agrupadoPorMesa[mesa]" 
                 class="registro-item"
                 [ngClass]="registro.tipo === 'resumen_mesa' ? 'resumen-mesa' : 'comanda-individual'">
              
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                <ion-text [color]="registro.tipo === 'resumen_mesa' ? 'success' : 'primary'">
                  <strong style="text-transform: uppercase; font-size: 0.8rem; display: block;">
                    {{ (registro.tipo === 'resumen_mesa' ? 'HISTORY.TICKET_PAYMENT' : 'HISTORY.ORDER_RECORD') | translate }}
                  </strong>
                  <ion-note style="font-size: 0.8rem; display: block; margin-top: 2px;">
                    {{ (registro.pagadoEn || registro.fecha) | date:'HH:mm' }}
                  </ion-note>
                </ion-text>
                
                  <ion-button fill="clear" color="dark" size="small" (click)="imprimirTicket(registro)" [attr.aria-label]="'HISTORY.PRINT_THIS_TICKET' | translate">
                    <ion-icon name="print-outline" slot="icon-only"></ion-icon>
                  </ion-button>
              </div>

              <!-- Detalle de Productos -->
              <ng-container *ngIf="registro.tipo === 'resumen_mesa'">
                <div *ngFor="let comanda of registro.pedidos" class="ion-margin-bottom">
                  <div style="font-size: 0.75rem; color: #888; margin-bottom: 4px; border-bottom: 1px dotted #ccc;">
                    {{ 'HISTORY.ORDER_AT' | translate:{time: (comanda.fecha | date:'HH:mm')} }}
                  </div>
                  <ul class="item-list">
                    <li *ngFor="let item of comanda.items">
                      <span class="item-qty">{{ item.cantidad }}x</span> 
                      <span class="item-name">{{ item.nombre }}</span>
                      <div *ngIf="item.opciones?.length" style="font-size: 0.8rem; color: #888; font-style: italic;">
                        + {{ item.opciones.join(', ') }}
                      </div>
                    </li>
                  </ul>
                </div>
              </ng-container>

              <ng-container *ngIf="registro.tipo !== 'resumen_mesa'">
                <ul class="item-list">
                  <li *ngFor="let item of registro.items">
                    <span class="item-qty">{{ item.cantidad }}x</span> 
                    <span class="item-name">{{ item.nombre }}</span>
                    <div *ngIf="item.opciones?.length" style="font-size: 0.8rem; color: #888; font-style: italic;">
                      + {{ item.opciones.join(', ') }}
                    </div>
                  </li>
                </ul>
              </ng-container>

              <div style="display: flex; justify-content: flex-end; margin-top: 10px; border-top: 1px dashed #ddd; padding-top: 8px;">
                <ion-text color="dark">
                  <strong>{{ 'HISTORY.TOTAL_TICKET' | translate }}: {{ registro.total | currency:'EUR':'symbol':'1.2-2' }}</strong>
                </ion-text>
              </div>
            </div>
          </div>
        </ion-accordion>
      </ng-container>
    </ion-accordion-group>
  </div>

  <!-- Estado vacío -->
  <div *ngIf="mesas.length === 0" class="ion-text-center ion-padding" style="margin-top: 100px;">
    <ion-icon name="search-outline" style="font-size: 4rem; color: #ccc;"></ion-icon>
    <h3 style="color: #666;">{{ 'HISTORY.NO_RESULTS' | translate }}</h3>
    <p style="color: #999;">{{ 'HISTORY.NO_RECORDS_FOUND' | translate }}</p>
  </div>
</ion-content>

