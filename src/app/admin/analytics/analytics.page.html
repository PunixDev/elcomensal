<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ 'ANALYTICS.TITLE' | translate }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="presentLanguagePopover($event)">
        <span class="language-flag">{{ getCurrentLanguageFlag() }}</span>
        <ion-icon name="chevron-down" size="small"></ion-icon>
      </ion-button>
      <ion-button (click)="refreshData()">
        <ion-icon name="refresh" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="dashboard-container">
    
    <!-- Filtros de tiempo -->
    <div style="margin-bottom: 1rem; display: flex; justify-content: flex-end;">
      <ion-segment [(ngModel)]="timeFilter" (ionChange)="calculateMetrics()">
        <ion-segment-button value="all">
          <ion-label>{{ 'ANALYTICS.FILTERS.ALL' | translate }}</ion-label>
        </ion-segment-button>
        <ion-segment-button value="month">
          <ion-label>{{ 'ANALYTICS.FILTERS.MONTH' | translate }}</ion-label>
        </ion-segment-button>
        <ion-segment-button value="week">
          <ion-label>{{ 'ANALYTICS.FILTERS.WEEK' | translate }}</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards">
      <!-- Total Revenue -->
      <ion-card class="summary-card">
        <ion-card-content>
          <div class="card-icon bg-success-light">
            <ion-icon name="cash-outline"></ion-icon>
          </div>
          <div class="card-info">
            <h3>{{ 'ANALYTICS.SUMMARY.REVENUE' | translate }}</h3>
            <span class="value">{{ totalRevenue | currency:'EUR':'symbol':'1.0-0' }}</span>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Total Orders -->
      <ion-card class="summary-card">
        <ion-card-content>
          <div class="card-icon bg-primary-light">
            <ion-icon name="receipt-outline"></ion-icon>
          </div>
          <div class="card-info">
            <h3>{{ 'ANALYTICS.SUMMARY.ORDERS' | translate }}</h3>
            <span class="value">{{ totalOrders }}</span>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Average Ticket -->
      <ion-card class="summary-card">
        <ion-card-content>
          <div class="card-icon bg-tertiary-light">
            <ion-icon name="stats-chart-outline"></ion-icon>
          </div>
          <div class="card-info">
            <h3>{{ 'ANALYTICS.SUMMARY.AVG_TICKET' | translate }}</h3>
            <span class="value">{{ averageTicket | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
        </ion-card-content>
      </ion-card>
      
      <!-- Top Hour -->
      <ion-card class="summary-card">
        <ion-card-content>
          <div class="card-icon bg-warning-light">
            <ion-icon name="time-outline"></ion-icon>
          </div>
          <div class="card-info">
            <h3>{{ 'ANALYTICS.SUMMARY.TOP_HOUR' | translate }}</h3>
            <span class="value">{{ topHour }}:00</span>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
      <!-- Sales by Category -->
      <ion-card class="chart-card">
        <ion-card-header>
          <ion-card-title>{{ 'ANALYTICS.CHARTS.SALES_CATEGORY' | translate }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="list-item-content" *ngFor="let cat of salesByCategory">
            <div class="item-header">
              <span class="item-name">{{ cat.name }}</span>
              <span class="item-value">{{ cat.value | currency:'EUR':'symbol':'1.0-0' }}</span>
            </div>
            <div class="progress-bg">
              <div class="progress-fill" [style.width.%]="cat.percentage" [style.background-color]="getColor(cat.index)"></div>
            </div>
          </div>
          <div *ngIf="salesByCategory.length === 0" style="padding: 20px; text-align: center; color: var(--ion-color-medium);">
            {{ 'ANALYTICS.CHARTS.NO_DATA' | translate }}
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Top Products -->
      <ion-card class="chart-card">
        <ion-card-header>
          <ion-card-title>{{ 'ANALYTICS.CHARTS.TOP_PRODUCTS' | translate }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="list-item-content" *ngFor="let prod of topProducts">
            <div class="item-header">
              <span class="item-name">{{ prod.name }}</span>
              <span class="item-value">{{ prod.quantity }} uds.</span>
            </div>
            <div class="progress-bg">
              <div class="progress-fill" [style.width.%]="prod.percentage" style="background-color: var(--ion-color-secondary);"></div>
            </div>
          </div>
          <div *ngIf="topProducts.length === 0" style="padding: 20px; text-align: center; color: var(--ion-color-medium);">
             {{ 'ANALYTICS.CHARTS.NO_DATA' | translate }}
          </div>
        </ion-card-content>
      </ion-card>
    </div>
  </div>
</ion-content>
