<ion-menu contentId="main-content" type="overlay">
  <ion-header>
    <ion-toolbar color="primary">
      <ion-title>
        <ion-icon
          name="settings"
          slot="start"
          style="margin-right: 8px"
          aria-hidden="true"
        ></ion-icon>
        {{ 'ADMIN.TITLE' | translate }}
      </ion-title>
      <ion-label
        *ngIf="trialActive"
        style="font-size: small; display: block; text-align: center"
        >{{ 'ADMIN.TRIAL_ACTIVE_DAYS' | translate:{days: remainingTrialDays}
        }}</ion-label
      >
    </ion-toolbar>
  </ion-header>
  <ion-content>
    <ion-list>
      <ion-item (click)="goToComanderos()">
        <ion-icon name="list-circle" slot="start" aria-hidden="true"></ion-icon>
        Gestionar Comanderos
      </ion-item>
      <ion-item (click)="goToCategorias()">
        <ion-icon name="albums" slot="start" aria-hidden="true"></ion-icon>
        {{ 'ADMIN.MANAGE_CATEGORIES' | translate }}
      </ion-item>
      <ion-item (click)="goToProductos()">
        <ion-icon name="fast-food" slot="start" aria-hidden="true"></ion-icon>
        {{ 'ADMIN.MANAGE_PRODUCTS' | translate }}
      </ion-item>
      <ion-item
        (click)="goToGenerarQR()"
        [disabled]="!isSubscribed && !trialActive"
      >
        <ion-icon name="qr-code" slot="start" aria-hidden="true"></ion-icon>
        {{ 'NAVIGATION.QR_GENERATOR' | translate }}
      </ion-item>
      <ion-item
        (click)="goToHistorial()"
        [disabled]="!isSubscribed && !trialActive"
      >
        <ion-icon name="archive" slot="start" aria-hidden="true"></ion-icon>
        {{ 'NAVIGATION.HISTORY' | translate }}
      </ion-item>
      <ion-item (click)="goToAnalytics()">
        <ion-icon name="bar-chart" slot="start" aria-hidden="true"></ion-icon>
        {{ 'ANALYTICS.TITLE' | translate }}
      </ion-item>

      <ion-item (click)="goToPromotions()">
        <ion-icon name="pricetag" slot="start" aria-hidden="true"></ion-icon>
        Promociones
      </ion-item>
      <ion-item
        *ngIf="!isSubscribed"
        (click)="goToSuscripcion()"
        color="primary"
      >
        <ion-icon name="card" slot="start" aria-hidden="true"></ion-icon>
        {{ 'ADMIN.SUBSCRIBE' | translate }}
      </ion-item>
      <ion-item
        *ngIf="isSubscribed && showManageInMenu"
        (click)="goToSuscripcion()"
        color="success"
      >
        <ion-icon name="card" slot="start" aria-hidden="true"></ion-icon>
        {{ 'ADMIN.MANAGE_SUBSCRIPTION' | translate }}
      </ion-item>
      <ion-item (click)="logout()">
        <ion-icon name="log-out" slot="start" aria-hidden="true"></ion-icon>
        {{ 'HEADER.LOGOUT' | translate }}
      </ion-item>
    </ion-list>
  </ion-content>
</ion-menu>

<ion-header [translucent]="true">
  <ion-toolbar style="padding: 0; position: relative">
    <ion-buttons slot="start">
      <ion-button (click)="toggleMenu()" fill="clear" style="font-weight: bold; --color: inherit;">
        <ion-icon name="menu" slot="start"></ion-icon>
        {{ 'ADMIN.TITLE' | translate }}
      </ion-button>
    </ion-buttons>
    <ion-title>
      <ion-icon
        name="settings"
        slot="start"
        style="margin-right: 8px"
        aria-hidden="true"
      ></ion-icon>
      <span *ngIf="barId" style="font-size: 0.8em; margin-left: 1em">
        <ion-icon name="key-outline" style="vertical-align: middle"></ion-icon>
        <strong>ID:</strong> {{ barId }}
      </span>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button
        *ngIf="showLanguageSelector"
        (click)="presentLanguagePopover($event)"
        fill="clear"
      >
        <span class="language-flag">{{ getCurrentLanguageFlag() }}</span>
        <ion-icon name="chevron-down" size="small"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content id="main-content" [fullscreen]="true">
  <div style="margin: 1em; text-align: center">
    <ion-card color="light" class="top-card">
      <ion-card-header>
        <ion-card-title>
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
              width: 100%;
            "
          >
            <div class="collapsed-status" *ngIf="!cardExpanded">
              <ng-container *ngIf="isSubscribed; else notSubscribed">
                <ion-label color="success" class="compact-label"
                  ><strong
                    >{{ 'ADMIN.SUBSCRIPTION_ACTIVE' | translate }}</strong
                  ></ion-label
                >
              </ng-container>
              <ng-template #notSubscribed>
                <ng-container *ngIf="trialActive; else noSub">
                  <ion-label color="warning" class="compact-label"
                    ><strong
                      >{{ 'ADMIN.TRIAL_ACTIVE_DAYS' | translate:{days:
                      remainingTrialDays} }}</strong
                    ></ion-label
                  >
                </ng-container>
                <ng-template #noSub>
                  <ion-label color="danger" class="compact-label"
                    ><strong
                      >{{ 'ADMIN.NO_SUBSCRIPTION' | translate }}</strong
                    ></ion-label
                  >
                </ng-template>
              </ng-template>
            </div>

            <div style="display: flex; align-items: center; gap: 0.25rem">
              <ion-button
                fill="clear"
                size="small"
                (click)="irAMesa($event)"
                title="{{ 'ADMIN.GO_TO_TABLE' | translate }}"
              >
                <ion-icon name="open-outline" slot="icon-only"></ion-icon>
              </ion-button>
              <ion-button
                fill="clear"
                size="small"
                (click)="toggleTopCard()"
                [attr.aria-expanded]="cardExpanded"
              >
                <ion-icon
                  [name]="cardExpanded ? 'chevron-up' : 'chevron-down'"
                ></ion-icon>
              </ion-button>
            </div>
          </div>
        </ion-card-title>
      </ion-card-header>
      <div class="collapsible" [class.collapsed]="!cardExpanded">
        <ion-card-content>
          <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
          <div
            *ngIf="isSubscribed; else trialBlock"
            style="display: flex; flex-direction: column; align-items: center"
          >
            <ion-label color="success" style="margin-bottom: 0.5em">
              <strong>{{ 'ADMIN.SUBSCRIPTION_ACTIVE' | translate }}</strong>
            </ion-label>
            <ion-button
              color="primary"
              (click)="gestionarSuscripcion()"
              style="width: 100%"
            >
              {{ 'ADMIN.MANAGE_SUBSCRIPTION' | translate }}
            </ion-button>
            <ion-button
              color="medium"
              expand="block"
              (click)="goToHistorial()"
              style="margin-top: 0.5em"
            >
              <ion-icon name="archive" slot="start"></ion-icon>
              {{ 'NAVIGATION.HISTORY' | translate }}
            </ion-button>
          </div>
          <ng-template #trialBlock>
            <div *ngIf="trialActive; else expiredBlock">
              <ion-label color="warning"
                ><strong
                  >{{ 'ADMIN.TRIAL_ACTIVE' | translate }} - {{
                  remainingTrialDays }} días restantes</strong
                ></ion-label
              >
            </div>
            <ng-template #expiredBlock>
              <ng-container *ngIf="!isSubscribed">
                <ion-label color="danger"
                  ><strong
                    >{{ 'ADMIN.NO_SUBSCRIPTION' | translate }}</strong
                  ></ion-label
                >
                <ion-button
                  color="medium"
                  expand="block"
                  (click)="goToHistorial()"
                  style="margin-bottom: 0.5em"
                  [disabled]="!isSubscribed"
                >
                  <ion-icon name="archive" slot="start"></ion-icon>
                  {{ 'NAVIGATION.HISTORY' | translate }}
                </ion-button>
                <ion-modal
                  [isOpen]="modalNombreBarAbierto"
                  (didDismiss)="cerrarModalNombreBar()"
                >
                  <ion-header>
                    <ion-toolbar color="primary">
                      <ion-title>Nombre del Bar</ion-title>
                      <ion-buttons slot="end">
                        <ion-button (click)="cerrarModalNombreBar()">
                          <ion-icon name="close"></ion-icon>
                        </ion-button>
                      </ion-buttons>
                    </ion-toolbar>
                  </ion-header>
                  <ion-content>
                    <div style="padding: 2em; text-align: center">
                      <ion-label position="stacked">Nombre del Bar</ion-label>
                      <ion-input
                        [(ngModel)]="barNombre"
                        name="barNombre"
                        style="
                          font-family: Pacifico, cursive;
                          font-size: 2em;
                          color: #0070f3;
                          text-align: center;
                        "
                      ></ion-input>
                      <ion-button
                        expand="block"
                        color="success"
                        style="margin-top: 2em"
                        (click)="cerrarModalNombreBar()"
                        >Guardar</ion-button
                      >
                    </div>
                  </ion-content>
                </ion-modal>
                <ion-button
                  color="primary"
                  (click)="goToSuscripcion()"
                  style="margin-top: 0.5em"
                >
                  {{ 'ADMIN.SUBSCRIBE' | translate }}
                </ion-button>
              </ng-container>
            </ng-template>
          </ng-template>
        </ion-card-content>
      </div>
    </ion-card>
  </div>
  
  <div class="comanderos-filter">
    <ion-chip [color]="filtroComanderoId === 'todos' ? 'primary' : 'medium'" (click)="cambiarFiltroComandero('todos')">
      <ion-label>Todos</ion-label>
    </ion-chip>
    <ion-chip *ngFor="let c of comanderos$ | async" [color]="filtroComanderoId === c.id ? 'primary' : 'medium'" (click)="cambiarFiltroComandero(c.id)">
      <ion-label>{{ c.descripcion }}</ion-label>
    </ion-chip>
  </div>

  <ion-grid>
    <ion-row>
      <ion-col size="12">
        <ion-card *ngIf="comandas.length">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="receipt" slot="start"></ion-icon>
              {{ 'ADMIN.RECEIVED_ORDERS' | translate }}
            </ion-card-title>
            <ion-button
              color="danger"
              size="small"
              (click)="confirmarLimpiarComandas()"
            >
              <ion-icon
                name="trash-sharp"
                slot="start"
                aria-hidden="true"
              ></ion-icon>
              {{ 'ADMIN.CLEAR_ORDERS' | translate }}
            </ion-button>
          </ion-card-header>
          <ion-card-content>
            <ion-grid>
              <ion-row>
                <ion-col
                  size="12"
                  size-sm="6"
                  size-md="4"
                  size-lg="3"
                  size-xl="2"
                  *ngFor="let mesa of mesasOrdenadas"
                >
                  <ion-card class="mesa-card" [class.has-call]="mesaTieneLlamada(mesa)">
                    <!-- Banner de llamada si activa -->
                    <div *ngIf="mesaTieneLlamada(mesa)" class="waiter-call-banner" (click)="atenderLlamada(mesa.key, $event)">
                      <ion-icon name="notifications-outline"></ion-icon>
                      <span>LLAMADA ACTIVA</span>
                    </div>

                    <ion-card-header>
                      <div class="mesa-header-top">
                        <div class="mesa-number">
                          Mesa {{mesa.key}}
                          <span *ngIf="getComensales(mesa)" style="font-size: 0.8em; color: #666; margin-left: 0.5em;">
                            <ion-icon name="people" style="vertical-align: middle;"></ion-icon> {{ getComensales(mesa) }}
                          </span>
                        </div>
                        <div class="time-ago">{{ getTimeAgo(getLatestFecha(mesa)) }}</div>
                      </div>
                      <div class="mesa-status-row">
                        <ion-badge [color]="badgeColor(mesa)">{{ badgeLabel(mesa) }}</ion-badge>
                        <!-- Botón Pagado rápido para limpiar mesa -->
                        <ion-button 
                          size="small" 
                          color="warning" 
                          (click)="confirmarMarcarMesaPagada(mesa.key)"
                          class="btn-quick-paid"
                        >
                          <ion-icon name="checkmark-done-outline" slot="start"></ion-icon>
                          Pagado
                        </ion-button>
                      </div>
                    </ion-card-header>

                    <ion-card-content>
                      <div class="mesa-total-row">
                        <span class="mesa-total-label">Total acumulado</span>
                        <span class="mesa-total-amount">{{ getTotalMesa(mesa.value) | currency:'EUR':'symbol':'1.2-2' }}</span>
                      </div>

                      <div class="mesa-actions" [class.dual-actions]="badgeColor(mesa) === 'danger'">
                        <ion-button
                          class="btn-main"
                          expand="block"
                          color="primary"
                          (click)="verInformeMesa(mesa.key)"
                        >
                          <ion-icon name="restaurant-outline" slot="start"></ion-icon>
                          GESTIONAR
                        </ion-button>
                        
                        <ion-button
                          *ngIf="badgeColor(mesa) === 'danger'"
                          class="btn-main"
                          expand="block"
                          color="success"
                          (click)="confirmarMarcarMesaPagada(mesa.key)"
                        >
                          <ion-icon name="card-outline" slot="start"></ion-icon>
                          COBRAR
                        </ion-button>
                      </div>

                      <div
                        *ngIf="mesasExpanded[mesa.key]"
                        style="margin-top: 0.75rem"
                      >
                        <ion-list>
                          <ion-item *ngFor="let comanda of getComandasComida(mesa)">
                            <ion-label>
                              <strong>Fecha:</strong> {{comanda.fecha |
                              date:'short'}}<br />
                              <strong>Pedido:</strong>
                              <ul>
                                <li *ngFor="let item of comanda.items">
                                  {{item.nombre}} x{{item.cantidad}}
                                  <span *ngIf="item.opciones?.length"
                                    >- Opciones: {{item.opciones.join(',
                                    ')}}</span
                                  >
                                </li>
                              </ul>
                              <div
                                *ngIf="comanda.observaciones"
                                style="margin-top: 0.5em"
                              >
                                <strong>Observaciones:</strong>
                                {{comanda.observaciones}}
                              </div>
                              <div style="margin-top: 0.5em">
                                <strong>Estado:</strong>
                                <span [ngSwitch]="comanda.estado">
                                  <span
                                    *ngSwitchCase="'preparando'"
                                    style="color: orange; font-weight: bold"
                                    >{{ 'MENU.STATUS_PREPARING' | translate
                                    }}</span
                                  >
                                  <span
                                    *ngSwitchCase="'preparado'"
                                    style="color: green; font-weight: bold"
                                    >{{ 'MENU.STATUS_PREPARED' | translate
                                    }}</span
                                  >
                                  <span
                                    *ngSwitchCase="'pago_pendiente'"
                                    style="color: #c77d00; font-weight: bold"
                                    >{{ 'MENU.PAYMENT_REQUESTED' | translate
                                    }}</span
                                  >
                                  <span
                                    *ngSwitchDefault
                                    style="color: gray; font-weight: bold"
                                    >{{ 'MENU.STATUS_RECEIVED' | translate
                                    }}</span
                                  >
                                </span>
                              </div>
                            </ion-label>
                            <ion-button
                              color="warning"
                              size="small"
                              (click)="actualizarEstadoComanda(comanda, 'preparando')"
                              *ngIf="comanda.estado !== 'preparando' && comanda.estado !== 'preparado' && comanda.estado !== 'pago_pendiente'"
                              >En preparación</ion-button
                            >
                            <ion-button
                              color="success"
                              size="small"
                              (click)="actualizarEstadoComanda(comanda, 'preparado')"
                              *ngIf="comanda.estado === 'preparando'"
                              >Preparado</ion-button
                            >
                          </ion-item>
                        </ion-list>
                      </div>
                    </ion-card-content>
                  </ion-card>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-content>
        </ion-card>
        <ion-card *ngIf="!comandas.length">
          <ion-card-content
            >{{ 'ADMIN.NO_PENDING_ORDERS' | translate }}</ion-card-content
          >
        </ion-card>
      </ion-col>
    </ion-row>
    <ion-row *ngIf="usuarioLogado === 'admin'">
      <ion-col size="12">
        <ion-card>
          <ion-card-header>
            <ion-card-title>Gestión de usuarios</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <form (ngSubmit)="agregarUsuario()">
              <ion-item>
                <ion-label position="floating">Nuevo usuario</ion-label>
                <ion-input
                  [(ngModel)]="nuevoUsuario"
                  name="nuevoUsuario"
                  required
                ></ion-input>
              </ion-item>
              <ion-item>
                <ion-label position="floating">Contraseña</ion-label>
                <ion-input
                  [(ngModel)]="nuevaPassword"
                  name="nuevaPassword"
                  type="password"
                  required
                ></ion-input>
              </ion-item>
              <ion-button expand="block" color="success" type="submit">
                <ion-icon name="person-add" slot="start"></ion-icon>
                Añadir usuario
              </ion-button>
            </form>
            <ion-list *ngIf="(usuarios$ | async)?.length">
              <ion-item *ngFor="let u of usuarios$ | async">
                <ion-label>{{u.usuario}}</ion-label>
                <ion-button
                  color="danger"
                  fill="clear"
                  slot="end"
                  (click)="eliminarUsuario(u.usuario)"
                  *ngIf="u.usuario !== 'admin'"
                >
                  <ion-icon name="trash-sharp"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>
