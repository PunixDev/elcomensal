<ion-header mode="md" class="ion-no-border">
  <ion-toolbar>
    <ion-title style="font-weight: 800">Mesa {{ mesaActual }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="marcarMesaPagada()" color="success" fill="solid" style="--border-radius: 10px; margin-right: 8px;">
        <ion-icon name="checkmark-done-outline" slot="start"></ion-icon>
        PAGADA
      </ion-button>
      <ion-button (click)="cerrar()">
        <ion-icon name="close-circle" size="large" color="medium"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="carta-content">
  <div class="main-container">
    
    <!-- Action Bar -->
    <div class="action-bar-modal no-print">
      <ion-button fill="soft" color="primary" (click)="imprimirInformeMesa()" size="small">
        <ion-icon name="print-outline" slot="start"></ion-icon>
        {{ filtroComanderoId === 'todos' ? 'Imprimir' : getComanderoName(filtroComanderoId) }}
      </ion-button>
      <ion-button fill="soft" color="tertiary" (click)="imprimirTotal()" size="small">
        <ion-icon name="receipt-outline" slot="start"></ion-icon>
        Ticket
      </ion-button>
      <ion-button fill="soft" color="secondary" (click)="hacerCalculoPorSeparado()" size="small">
        <ion-icon name="calculator-outline" slot="start"></ion-icon>
        Dividir
      </ion-button>
    </div>

    <!-- Informe List -->
    <div class="resumen-lista" *ngIf="informeMesa && informeMesa.length">
      <div *ngFor="let comanda of informeMesa" class="comanda-group">
        <div class="comanda-header-modal">
          <span class="fecha">{{ comanda?.fecha | date : "HH:mm" }}</span>
          <ion-badge [color]="comanda.estado === 'preparado' ? 'success' : (comanda.estado === 'preparando' ? 'warning' : 'medium')">
            {{ comanda.estado === 'preparado' ? 'Preparado' : (comanda.estado === 'preparando' ? 'En preparaci√≥n' : 'Recibido') }}
          </ion-badge>
        </div>

        <div *ngFor="let item of comanda?.items; let i = index" class="resumen-item">
          <div style="display: flex; flex-direction: column; gap: 4px; flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span class="item-name">{{ item?.nombre }}</span>
              <!-- Controles de cantidad solo si no es solo lectura (filtro todos) -->
              <div *ngIf="filtroComanderoId === 'todos'" class="qty-controls" style="display: flex; align-items: center; border: 1px solid #ddd; border-radius: 8px; padding: 2px;">
                <ion-button fill="clear" size="small" color="danger" (click)="decrementarCantidad(comanda, i)" style="height: 24px; min-height: 0;">
                  <ion-icon name="remove" size="small" slot="icon-only"></ion-icon>
                </ion-button>
                <span style="font-weight: 800; min-width: 20px; text-align: center; font-size: 0.9em;">{{ item?.cantidad }}</span>
                <ion-button fill="clear" size="small" color="success" (click)="incrementarCantidad(comanda, i)" style="height: 24px; min-height: 0;">
                  <ion-icon name="add" size="small" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
              <span *ngIf="filtroComanderoId !== 'todos'" style="font-weight: bold;">x{{ item?.cantidad }}</span>
            </div>
            <div *ngIf="item?.opciones?.length" class="item-options">
              {{ item.opciones.join(", ") }}
            </div>
          </div>
          <span class="item-price">
            {{ (getPrecioProducto ? getPrecioProducto(item?.id) : 0) * item?.cantidad | currency:'EUR':'symbol':'1.2-2' }}
          </span>
        </div>

        <div *ngIf="comanda?.observaciones" class="comanda-obs">
          <ion-icon name="chatbubble-outline" slot="start"></ion-icon>
          <span>{{ comanda?.observaciones }}</span>
        </div>

        <div class="comanda-actions no-print" *ngIf="filtroComanderoId === 'todos'">
          <ion-button
            color="warning"
            size="small"
            fill="outline"
            (click)="aplicarEstado(comanda, 'preparando')"
            *ngIf="comanda.estado !== 'preparando' && comanda.estado !== 'preparado' && comanda.estado !== 'pago_pendiente'"
          >
            Preparar
          </ion-button>
          
          <ng-container *ngIf="comanda.estado === 'preparando'">
            <ion-button color="success" size="small" (click)="aplicarEstado(comanda, 'preparado')">
              Listo
            </ion-button>
            <ion-button color="medium" fill="clear" size="small" (click)="aplicarEstado(comanda, '')">
              <ion-icon name="arrow-undo-outline"></ion-icon>
            </ion-button>
          </ng-container>

          <ion-button
            color="medium"
            fill="clear"
            size="small"
            (click)="aplicarEstado(comanda, 'preparando')"
            *ngIf="comanda.estado === 'preparado'"
          >
            <ion-icon name="arrow-undo-outline" slot="start"></ion-icon>
            Volver
          </ion-button>
        </div>
      </div>
    </div>

    <div *ngIf="informeMesa && !informeMesa.length" class="empty-state-modal">
      <ion-icon name="receipt-outline"></ion-icon>
      <p>No hay pedidos para esta mesa.</p>
    </div>

  </div>
</ion-content>

<!-- Total Footer -->
<div class="modal-footer-sticky no-print" *ngIf="informeMesa && informeMesa.length">
  <div class="total-container">
    <span class="total-label">Suma total:</span>
    <span class="total-amount">{{ informeTotal | currency:'EUR':'symbol':'1.2-2' }}</span>
  </div>
</div>
